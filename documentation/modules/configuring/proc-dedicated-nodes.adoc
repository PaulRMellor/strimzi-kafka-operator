// Module included in the following assemblies:
//
// assembly-scheduling.adoc

[id='proc-dedicated-nodes-{context}']
= Configuring pod affinity for dedicated nodes

[role="_abstract"]
You can dedicate a set of worker nodes exclusively to your Kafka brokers so that no other applications can compete with Kafka for resources on those nodes.

To configure dedicated worker nodes for Kafka pods in a specific pool, set taints on the worker nodes, and configure `tolerations`` and `nodeAffinity` in your `KafkaNodePool` resource.

.Prerequisites

* A Kubernetes cluster
* A running Cluster Operator
* Dedicated worker nodes without scheduled workloads

.Procedure

. Taint the dedicated worker nodes to prevent other pods from being scheduled on them:
+
[source,shell]
----
kubectl taint node <name_of_node> dedicated=Kafka:NoSchedule
----
+
This command marks the node so that only pods with a corresponding toleration can use it.

. Label the dedicated nodes where you want to schedule your Kafka pods. 
+
If the nodes aren't already labeled, apply labels using `kubectl label`:
+
[source,shell,subs="+quotes,attributes+"]
----
kubectl label node <name_of_node> dedicated=kafka
----

. In your `KafkaNodePool` custom resource, edit the `tolerations` and `affinity` properties in the `spec.template.pod` section.
+
To assign Kafka pods from the same node pool to a worker node, add a `nodeAffinity` rule. 
+
* Add a toleration that exactly matches the taint you applied to the node.
The Kafka pods are only scheduled on the dedicated nodes.
* Use `nodeSelectorTerms` with `matchExpressions` to specify the key (label name) and values of the nodes you want to schedule pods on. 
Pods are only scheduled on nodes that match these expressions.
+
.Example affinity configuration for dedicated nodes
[source,yaml,subs=attributes+]
----
apiVersion: {KafkaNodePoolApiVersion}
kind: KafkaNodePool
metadata:
  name: broker
  labels:
    strimzi.io/cluster: my-cluster
spec:
  replicas: 3
  roles:
    - broker
  template:
    pod:
      tolerations:
        - key: "dedicated"
          operator: "Equal"
          value: "kafka"
          effect: "NoSchedule"
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: dedicated
                operator: In
                values:
                - kafka
  # ...
----

. Apply the changes to the `KafkaNodePool` configuration.