// Module included in the following assemblies:
//
// upgrade/assembly-upgrade-kafka.adoc

[id='con-strategies-for-upgrading-clients-{context}']

= Strategies for upgrading clients

[role="_abstract"]
Upgrading Kafka clients ensures that they benefit from the features, fixes, and improvements that are introduced in new versions of Kafka. 
Upgraded clients maintain compatibility with other upgraded Kafka components.
The performance and stability of the clients might also be improved.

Consider the best approach for upgrading Kafka clients and brokers to ensure a smooth transition.
The chosen upgrade strategy depends on whether you are upgrading brokers or clients first. 
The decision to upgrade clients or brokers first depends on several factors, such as the number of applications that need to be upgraded and how much downtime is tolerable.
Absent of changes to the log message version, you can usually update in any order without risking downtime.

If you upgrade clients before brokers, some new features may not work as they are not yet supported by brokers. 
However, brokers can handle producers and consumers running with different versions and supporting different log message versions.

It's usually better to upgrade brokers first, so that applications can start using new features as soon as they are upgraded.
If you do upgrade brokers first, there may be a need for down-conversion or retention of older log message versions to ensure compatibility with older applications. 

.Consumers first strategy

For the consumers first strategy, upgrade all the consuming applications, and then upgrade all the producing applications. 

This strategy assumes that all consumers in your organization can be upgraded in a coordinated way, and it does not work for applications that are both consumers and producers.
If there is a problem with the upgraded clients, there is a risk that messages in the new format might be added to the message log so that you cannot revert to the previous consumer version.

IMPORTANT: If upgrading from a version of Kafka earlier than version 3.0.0, the log message format needs to be changed at the topic-level (`message.format.version`) or broker-level (`log.message.format.version`) after upgrading the consumer applications and before upgrading the producer applications. From Kafka 3.0, the log message version does not need to be set. 

.Consumers first strategy with down-conversion at the topic level

Broker down-conversion is the process of converting messages from a new version to an older version before delivering them to consumers. 
You can use broker down-conversion if you are not upgrading all topics or applications. 
The older message version needs to be supported. 
You configure broker down-conversion by setting the topic-level (`message.format.version`) or broker-level (`log.message.format.version`) message version to the older version. 
Broker down-conversion puts extra load on the brokers and should be avoided or only used temporarily. 

For the consumers first strategy with down-conversion at the topic level, you perform the following steps to upgrade clients:

. Change the topic-level `message.format.version` to the old version
(or rely on the topic defaulting to the broker-level `log.message.format.version`).
. Upgrade all the consuming and producing applications.
. Verify that the upgraded applications function correctly.
. Change the topic-level `message.format.version` to the new version.

Although this strategy uses broker down-conversion, the load on the brokers is minimized because it is only required for a single topic (or small group of topics) at a time. 
It also works for applications that are both consumers and producers of the same topic. 
The approach ensures that the upgraded producers and consumers are working correctly before you commit to using the new message format version.
The main drawback of this approach is that it can be complicated to manage in a cluster with many topics and applications.

[TIP]
====
The following Kafka broker metrics help monitor the performance of message down-conversion:

* `kafka.network:type=RequestMetrics,name=MessageConversionsTimeMs,request={Produce|Fetch}` provides metrics on the time taken to perform message conversion. 
* `kafka.server:type=BrokerTopicMetrics,name={Produce|Fetch}MessageConversionsPerSec,topic=([-.\w]+)` provides metrics on the number of messages converted over a period of time.  

You can track Kafka client names and versions using this metric:

* `kafka.server:type=socket-server-metrics,clientSoftwareName=<name>,clientSoftwareVersion=<version>,listener=<listener>,networkProcessor=<processor>`  
====