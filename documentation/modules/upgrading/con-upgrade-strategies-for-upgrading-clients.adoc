// Module included in the following assemblies:
//
// upgrade/assembly-upgrade-kafka.adoc

[id='con-strategies-for-upgrading-clients-{context}']

= Strategies for upgrading clients

[role="_abstract"]
The goal of upgrading clients is to enable them to consume new message formats produced by updated producers.
You do this by upgrading all the consumers for a topic _before_ upgrading any of the producers.
Upgrading consumers first ensures that consuming applications can understand the new message format before any new messages in that format are produced.
The chosen upgrade strategy depends on a number of factors, such as the number of applications that need to be upgraded and how much downtime is tolerable. 
You can combine more than one strategy.

.Consumers first strategy

For the consumers first strategy, upgrade all the consuming applications, and then upgrade all the producing applications. 

This strategy assumes that all consumers in your organization can be upgraded in a coordinated way, and it does not work for applications that are both consumers and producers.
If there is a problem with the upgraded clients, there is a risk that messages in the new format might be added to the message log so that you cannot revert to the previous consumer version.

IMPORTANT: If upgrading from a version of Kafka earlier than version 3.0.0, the log message format needs to be changed at the topic-level (`message.format.version`) or broker-level (`log.message.format.version`) after upgrading the consumer applications and before upgrading the producer applications. From Kafka 3.0, the log message version does not need to be set. 

.Consumers first strategy with down-conversion at the topic level

Broker down-conversion is the process of converting messages from a new version to an older version before delivering them to consumers. 
You can use broker down-conversion if you are not upgrading all topics or applications. 
The older message version needs to be supported. 
You configure broker down-conversion by setting the topic-level (`message.format.version`) or broker-level (`log.message.format.version`) message version to the older version. 
Broker down-conversion puts extra load on the brokers and should be avoided or only used temporarily. 

For the consumers first strategy with down-conversion at the topic level, you perform the following steps to upgrade clients:

. Change the topic-level `message.format.version` to the old version
(or rely on the topic defaulting to the broker-level `log.message.format.version`).
. Upgrade all the consuming and producing applications.
. Verify that the upgraded applications function correctly.
. Change the topic-level `message.format.version` to the new version.

Although this strategy uses broker down-conversion, the load on the brokers is minimized because it is only required for a single topic (or small group of topics) at a time. 
It also works for applications that are both consumers and producers of the same topic. 
The approach ensures that the upgraded producers and consumers are working correctly before you commit to using the new message format version.
The main drawback of this approach is that it can be complicated to manage in a cluster with many topics and applications.

TIP: You can use Kafka metrics to monitor the performance of message down-conversion. 
The _message conversion time_ metric measures the time taken to perform message conversion. 
The _message conversion rate_ metric measures the number of messages converted over a period of time.  