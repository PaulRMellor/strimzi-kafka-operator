// Module included in the following assemblies:
//
// assembly-config.adoc

[id='proc-setting-broker-limits-{context}']

= Setting throughput and storage limits on brokers

[role="_abstract"]
This procedure describes how to set throughput and storage limits on brokers in your Kafka cluster.
Enable a quota plugin and configure limits using `quotas` properties in the `Kafka` resource.

* The `strimzi` type enables the _Kafka Static Quota_ plugin.
* The `kafka` type enables the built-in Kafka plugin. 

Only one quota plugin can be enabled. 
The built-in Kafka plugin is enabled by default.
Enabling the `strimzi` plugin automatically disables the built-in plugin.

You can limit clients interacting with your brokers by setting byte-rate thresholds for producer and consumer bandwidth.

* Using the strimzi plugin, the total limit is distributed dynamically across all clients.
For example, if you set a 40 MBps producer byte-rate threshold, the distribution across two producers is not static. 
If one producer is using 10 MBps, the other can use up to 30 MBps.
* Using the `kafka` plugin, limits are applied per broker.
For example, setting a 20 MBps producer byte-rate threshold limits each producer to 20 MBps on a per-broker basis.

Additional `strimzi` plugin options:

* Set storage quotas to throttle Kafka producers based on disk storage utilization. 
Limits can be specified in bytes (`minAvailableBytesPerVolume`) or percentage (`minAvailableRatioPerVolume`) of available disk space, applying to each disk individually. 
When any broker in the cluster exceeds the configured disk threshold, clients are throttled. 
This prevents disks from filling up too quickly and exceeding capacity, which can cause issues that are hard to rectify.
* Exclude specific users (clients) from the restrictions.

Additional `kafka` plugin options:

* Set CPU utilization limits for each client as a percentage of the network threads and I/O threads on a per-broker basis.
* Set the number of concurrent partition creation and deletion operations (mutations) allowed per second on a per-broker basis.

NOTE: With the `strimzi` plugin, you see only aggregated quota metrics, not per-client metrics.

.Prerequisites

* The Cluster Operator that manages the Kafka cluster is running.

.Procedure

. Add the plugin configuration to the `quotas` section of the `Kafka` resource.
+
The `strimzi` plugin configuration is shown in this example.
+
--
.Example `strimzi` plugin configuration
[source,yaml,subs="+attributes"]
----
apiVersion: {KafkaApiVersion}
kind: Kafka
metadata:
  name: my-cluster
spec:
  kafka:
    # ...
    quotas:
      type: strimzi
      producerByteRate: 1000000 # <1>
      consumerByteRate: 1000000 # <2>
      minAvailableBytesPerVolume: 500000000000 # <3>
      excludedPrincipals: # <4>
        - my-user
----
<1> Sets a producer byte-rate threshold of 1 MBps.
<2> Sets a consumer byte-rate threshold of 1 MBps.
<3> Sets an available bytes limit for storage of 500 GB.
<4> Excludes `my-user` from the restrictions.
--
+
`minAvailableBytesPerVolume` and `minAvailableRatioPerVolume` are mutually exclusive.
Only configure one of these parameters.
+
.Example `kafka` plugin configuration
[source,yaml,subs="+attributes"]
----
apiVersion: {KafkaApiVersion}
kind: Kafka
metadata:
  name: my-cluster
spec:
  kafka:
    # ...
    quotas:
      type: kafka
      producerByteRate: 1000000
      consumerByteRate: 1000000
      requestPercentage: 55 # <1>
      controllerMutationRate: 50 # <2>
----
<1> Sets the CPU utilization limit to 55%.
<2> Sets the controller mutation rate to 50 operations per second.

. Apply the changes to the `Kafka` configuration.

[role="_additional-resources"]
.Additional resources

* link:{BookURLConfiguring}#type-QuotasPluginStrimzi-reference[`QuotasPluginStrimzi` schema reference^]
* link:{BookURLConfiguring}#type-QuotasPluginKafka-reference[`QuotasPluginKafka` schema reference^]
