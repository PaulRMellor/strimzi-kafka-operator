// Module included in the following module:
//
// con-oauth-config.adoc

[id='proc-oauth-authorization-broker-config-{context}']
= Configuring {oauth} authorization support

This procedure describes how to configure Kafka brokers to use {oauth} authorization using {oauth-server} Authorization Services.

Some of the properties used to configure authorization for Kafka brokers might already be configured for xref:proc-oauth-authentication-broker-config-{context}[{oauth} authentication].
If so, they are also used for authorization if specific authorization properties are not defined.
The properties are highlighted in this procedure.

.Before you begin
Consider the access you require or want to limit for certain users.
You can use a combination of groups, roles, clients and users to configure access.

Typically, groups are used to match users based on organizational departments or geographical locations.
And roles are used to match users based on their function.

With {oauth-server}, you can store users and groups in LDAP, whereas clients and roles cannot be stored this way.
Storage and access to user data may be a factor in how you choose to configure authorization policies.

NOTE: xref:ref-kafka-authorization-super-user[Super users] always have unconstrained access to a Kafka broker regardless of the authorization implemented on Kafka broker.

.Prerequisites

* {ProductName} must be configured to use {oauth} with {oauth-server} for xref:assembly-oauth-authentication_str[token-based authentication].
You use the same {oauth-server} server endpoint when you set up authorization.
* You need to understand how to manage policies and permissions for Keycloak Authorization Services, as described in the {oauth-keycloak-doc}.


.Procedure

. Access the {oauth-server} Admin Console or use the {oauth-server} Admin CLI to enable Authorization Services for the Kafka broker client you created when setting up {oauth} authentication.
. Use Authorization Services to define resources, authorization scopes, policies and permissions for the client.
. Bind the permissions to users and clients by assigning them roles and groups.
. Configure the Kafka brokers to use the `{oauth-server}RBACAuthorizer`.
. Add the following to the Kafka `server.properties` configuration file to install the authorizer in Kafka:
+
[source,env,subs="+quotes,attributes"]
----
authorizer.class.name=io.strimzi.kafka.oauth.server.authorizer.KeycloakRBACAuthorizer
principal.builder.class=io.strimzi.kafka.oauth.server.authorizer.JwtKafkaPrincipalBuilder
----

. Add configuration for the Kafka brokers to access the authorization server and Authorization Services.
+
Here we show example configuration added as additional properties to `server.properties`, but you can also define them as environment variables using capitalized or upper-case naming conventions.
+
[source,env,subs="+quotes,attributes"]
----
strimzi.authz.token.endpoint.uri="https://_<auth-server-address>_/token" <1>
strimzi.authz.client.id="kafka" <2>
----
<1> The {oauth} token endpoint URL to Keycloak. For production, always use HTTPs.
For example, _\https://keycloak:8443/auth/realms/master/protocol/openid-connect/token_.
<2> The client ID of the {oauth} client definition in Keycloak that has Authorization Services enabled. Typically, `kafka` is used as the ID.
+
If either of these properties are not added, the equivalent token endpoint and client ID properties configured for {oauth} authentication are used.

. (Optional) Add configuration for specific Kafka clusters.
+
For example:
+
[source,env,subs="+quotes,attributes"]
----
strimzi.authz.kafka.cluster.name="kafka-cluster" <1>
----
<1> The name of a specific Kafka cluster.
Names are used to target permissions,
making it possible to manage multiple clusters within the same Keycloak realm.
The default value is `kafka-cluster`.

. (Optional) Delegate to simple authorization.
+
For example:
+
[source,env,subs="+quotes,attributes"]
----
strimzi.authz.delegate.to.kafka.acl="false" <1>
----
<1> Flag to delegate authorization to Kafka `SimpleACLAuthorizer` if access is denied by Keycloak Authorization Services policies.
The default is `false`.

. (Optional) Add TLS configuration for inter-broker communication.
+
For example:
+
[source,env,subs="+quotes,attributes"]
----
strimzi.authz.ssl.truststore.location=_<path-to-truststore>_ <1>
strimzi.authz.ssl.truststore.password=_<my-truststore-password>_ <2>
strimzi.authz.ssl.truststore.type=JKS <3>
strimzi.authz.ssl.secure.random.implementation=SHA1PRNG <4>
strimzi.authz.ssl.endpoint.identification.algorithm=HTTPS <5>
----
<1> The path to the truststore that contain the certificates.
<2> The password for the truststore.
<3> The truststore type.
If not set, the default Java keystore type is used.
<4> Random number generator implementation.
If not set, the Java platform SDK default is used.
<5> Hostname verification.
If set to an empty string, the hostname verification is turned off.
If not set, the default value is `HTTPS`, which enforces hostname verification for server certificates.
+
If any of the TLS properties are not added, the equivalent properties used for {oauth} authentication are used.

. Verify the configured permissions by accessing Kafka brokers as clients or  users with specific roles, making sure they have the necessary access, or do not have the access they are not supposed to have.
