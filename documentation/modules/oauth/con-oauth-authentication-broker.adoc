// Module included in the following assemblies:
//
// assembly-oauth.adoc

[id='con-oauth-authentication-broker-{context}']
= {oauth} Kafka broker configuration

Kafka broker configuration for {oauth} involves:

* Client configuration (for the Kafka broker) on an authorization server
* {oauth} authentication configuration in the Kafka cluster

NOTE: In relation to the authorization server, Kafka brokers and Kafka clients are both regarded as {oauth} clients.

== {oauth} client configuration on an authorization server

To configure a Kafka broker to validate the token received during session initiation,
the recommended approach is to create a {oauth} _client_ definition in an authorization server, configured as _confidential_, with client credentials enabled:

* Client ID of `Kafka`
* Client ID and secret as the authentication mechanism

== {oauth} authentication configuration in the Kafka cluster

To use {oauth} authentication in the Kafka cluster, you specify a TLS listener configuration for your Kafka cluster custom resource with the authentication method `oauth`:

.Assigining the authentication method type for {oauth}
[source,yaml,subs="+quotes, attributes"]
----
apiVersion: {KafkaApiVersion}
kind: Kafka
spec:
  kafka:
    listeners:
      tls:
        authentication:
          type: *oauth*
          #...
----

You can configure `plain`, `tls` and `external` listeners, as described in xref:assembly-configuring-kafka-broker-listeners-deployment-configuration-kafka[Kafka broker listeners],
but it is recommended not to use `plain` listeners with {oauth} as this creates a vulnerability to network eavesdropping and unauthorized access through token theft.

You configure an `external` listener with `type: oauth` for a secure transport layer to communicate with the client.

.Using {oauth} with an external listener
[source,yaml,subs="+quotes"]
----
# ...
listeners:
  tls:
    authentication:
      type: oauth
  external:
    type: loadbalancer
    tls: true
    authentication:
      *type: oauth*
    #...
----

The `tls` property is _true_ by default, so it can be left out.

When you've defined the type of authentication as {oauth}, you add configuration based on the type of validation, either as <<con-oauth-authentication-broker-fast-local, fast local JWT validation>> or <<con-oauth-authentication-broker-intro-local, token validation using an introspection endpoint>>.

The procedure to configure {oauth} for listeners, with descriptions and examples, is described in xref:proc-oauth-broker-config-{context}[Configuring {oauth} support for Kafka brokers].

[[con-oauth-authentication-broker-fast-local]]
== Fast local JWT token validation configuration

Fast local JWT token validation checks a JWT token signature locally.

The local check ensures a token:

* Conforms to type by containing a (_typ_) claim value of `Bearer` for an access token
* Is valid (not expired)
* Has an issuer that matches a `validIssuerURI`

You specify a `validIssuerUri` attribute when you configure the listener, so that any tokens not issued by the authorization server are rejected.

The authorization server does not need to be contacted during fast local JWT token validation.
You activate fast local JWT token validation by specifying a `jwksEndpointUri` attribute, the endpoint exposed by the {oauth} authorization server.
The endpoint contains the public keys used to validate signed JWT tokens, which are sent as credentials by Kafka clients.

NOTE: All communication with the authorization server should be performed using HyperText Transfer Protocol Secure (HTTPS).

You can configure a certificate truststore as a Kubernetes Secret in your {ProductName} project namespace, and use a `tlsTrustedCertificates` attribute to point to the Kubernetes Secret containing the truststore file.

You might want to configure a `userNameClaim` to properly extract a username from the JWT token.
If you want to use Kafka ACL authorization, you need to identify the user by their username during authentication.
(The `sub` claim in JWT tokens is typically a unique ID, not a username.)

.Example configuration for fast local JWT token validation
[source,yaml,subs="+quotes, attributes"]
----
apiVersion: {KafkaApiVersion}
kind: Kafka
spec:
  kafka:
    listeners:
      tls:
        authentication:
          type: oauth
          validIssuerUri: <__https://<auth-server-address>/auth/realms/tls__>
          jwksEndpointUri: <__https://<auth-server-address>/auth/realms/tls/protocol/openid-connect/certs__>
          userNameClaim: preferred_username
          tlsTrustedCertificates:
          - secretName: oauth-server-cert
            certificate: ca.crt
----

[[con-oauth-authentication-broker-intro-local]]
== {oauth} introspection endpoint configuration

Token validation using {oauth} an introspection endpoint treats a received access token as opaque.
The Kafka broker sends an access token to the introspection endpoint, which responds with the token information necessary for validation.
Importantly, it returns up-to-date information if the specific access token is valid, and also information about when the token expires.

To configure {oauth} introspection-based validation, you specify an `introspectionEndpointUri` attribute rather than the `jwksEndpointUri` attribute specified for fast local JWT token validation.
Depending on the authorization server, you typically have to specify a `clientId` and `clientSecret`, as the introspection endpoint is usually protected.

.Example configuration for an introspection endpoint
[source,yaml,subs="+quotes, attributes"]
----
apiVersion: {KafkaApiVersion}
kind: Kafka
spec:
  kafka:
    listeners:
      tls:
        authentication:
          type: oauth
          clientId: kafka-broker
          clientSecret:
            secretName: my-cluster-oauth
            key: clientSecret
          validIssuerUri: <__https://<auth-server-address>/auth/realms/tls__>
          introspectionEndpointUri: <__https://<auth-server-address>/auth/tls/external/protocol/openid-connect/token/introspect__>
          userNameClaim: preferred_username
          tlsTrustedCertificates:
          - secretName: oauth-server-cert
            certificate: ca.crt
----
